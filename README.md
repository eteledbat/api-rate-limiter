# ğŸš€ é«˜æ€§èƒ½åˆ†å¸ƒå¼é€Ÿç‡é™åˆ¶å™¨

ä¸€ä¸ªä¸“ä¸ºOpenAI APIå…¼å®¹è®¾è®¡çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼é€Ÿç‡é™åˆ¶ç³»ç»Ÿï¼Œåœ¨Windowsç¯å¢ƒä¸‹å•èŠ‚ç‚¹å¯è¾¾738+ QPSï¼Œä¸‰èŠ‚ç‚¹é›†ç¾¤å¯è¾¾2463+ QPSã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ¯ **åŠŸèƒ½ç‰¹æ€§**
- âœ… **å®Œå…¨å…¼å®¹OpenAI APIæ ¼å¼** - æ”¯æŒæ‰€æœ‰ä¸»æµOpenAIå®¢æˆ·ç«¯
- âœ… **ä¸‰ç»´é€Ÿç‡é™åˆ¶** - RPM (è¯·æ±‚/åˆ†é’Ÿ) + Input TPM + Output TPM
- âœ… **ç²¾ç¡®æ»‘åŠ¨çª—å£** - åŸºäºRedisæœ‰åºé›†åˆçš„æ¯«ç§’çº§ç²¾åº¦
- âœ… **åˆ†å¸ƒå¼æ¶æ„** - å¤šèŠ‚ç‚¹æ— çŠ¶æ€è®¾è®¡ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•
- âœ… **é«˜å¯ç”¨è®¾è®¡** - èŠ‚ç‚¹æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡

### ğŸš€ **æ€§èƒ½ç‰¹æ€§**
- âš¡ **é«˜æ€§èƒ½**: Windowsç¯å¢ƒå•èŠ‚ç‚¹738+ QPSï¼Œä¸‰èŠ‚ç‚¹2463+ QPS
- ğŸ”„ **çº¿æ€§æ‰©å±•**: å®Œç¾çš„3.33å€æ‰©å±•æ¯”ä¾‹
- ğŸ“Š **ä½å»¶è¿Ÿ**: å¹³å‡å“åº”æ—¶é—´1.3msï¼ŒP99 < 20ms  
- ğŸ’¯ **é«˜å¯é **: æµ‹è¯•ä¸­100%æˆåŠŸç‡
- ğŸ§ **è·¨å¹³å°**: é¢„æµ‹Linuxç¯å¢ƒä¸‹å¯è¾¾6000+ QPS

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FastAPI Node  â”‚    â”‚   FastAPI Node  â”‚    â”‚   FastAPI Node  â”‚
â”‚   Port: 8003    â”‚    â”‚   Port: 8004    â”‚    â”‚   Port: 8005    â”‚
â”‚   738+ QPS      â”‚    â”‚   738+ QPS      â”‚    â”‚   738+ QPS      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      Redis Server         â”‚
                    â”‚   å…±äº«çŠ¶æ€ç®¡ç† + Luaè„šæœ¬   â”‚
                    â”‚    é«˜æ€§èƒ½åŸå­æ“ä½œ         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ æ€§èƒ½è¡¨ç°

### ğŸ“Š **åŸºå‡†æµ‹è¯•ç»“æœ**

| é…ç½® | QPS | æˆåŠŸç‡ | å¹³å‡å»¶è¿Ÿ | P99å»¶è¿Ÿ |
|------|-----|--------|----------|---------|
| **å•èŠ‚ç‚¹** | 738+ | 100% | 1.3ms | 16.1ms |
| **ä¸‰èŠ‚ç‚¹é›†ç¾¤** | 2463+ | 100% | <2ms | <20ms |
| **é¢„æµ‹Linuxæ€§èƒ½** | 6000+ | - | - | - |

### ğŸš€ **æ‰©å±•æ€§éªŒè¯**
```
å•èŠ‚ç‚¹: 738 QPS
ä¸‰èŠ‚ç‚¹: 2463 QPS (3.33å€æ‰©å±•)
â†’ æ¥è¿‘å®Œç¾çš„çº¿æ€§æ‰©å±•ï¼
```

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### ğŸ“‹ **ç¯å¢ƒè¦æ±‚**
- Python 3.8+
- Redis 6.0+
- Windows 10+ æˆ– Linux

### âš¡ **å¿«é€Ÿå®‰è£…**
```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repository-url>
cd dist_rate_limiter

# 2. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 3. å¯åŠ¨Redis (æœ¬åœ°)
redis-server

# 4. å¯åŠ¨æœåŠ¡èŠ‚ç‚¹
start_windows_servers.bat
```

### ğŸ§ª **æ€§èƒ½æµ‹è¯•**
```bash
# å•èŠ‚ç‚¹æ€§èƒ½æµ‹è¯•
python tests/single_node_performance_test.py

# å¤šèŠ‚ç‚¹é›†ç¾¤æµ‹è¯•  
python tests/test_client.py

# åŠŸèƒ½éªŒè¯æµ‹è¯•
python tests/rate_limit_test.py
```

## ğŸ“– ä½¿ç”¨è¯´æ˜

### ğŸ”‘ **API Keyé…ç½®**
ç¼–è¾‘ `app/config.py` æ·»åŠ æ‚¨çš„API Keysï¼š

```python
API_KEYS_CONFIG = {
    "your-api-key": {
        "name": "Your Service",
        "rpm": 1000,        # æ¯åˆ†é’Ÿè¯·æ±‚æ•°é™åˆ¶
        "input_tpm": 50000, # è¾“å…¥tokenæ¯åˆ†é’Ÿé™åˆ¶
        "output_tpm": 10000 # è¾“å‡ºtokenæ¯åˆ†é’Ÿé™åˆ¶
    },
    "unlimited-key": {      # æµ‹è¯•ç”¨æ— é™åˆ¶key
        "name": "Unlimited Test",
        "rpm": 999999,
        "input_tpm": 99999999,
        "output_tpm": 99999999
    }
}
```

### ğŸŒ **å®¢æˆ·ç«¯ä½¿ç”¨**

**æ ‡å‡†OpenAIå®¢æˆ·ç«¯**:
```python
import openai

client = openai.OpenAI(
    base_url="http://127.0.0.1:8003/v1",  # æŒ‡å‘æ‚¨çš„æœåŠ¡
    api_key="your-api-key"
)

response = client.chat.completions.create(
    model="gpt-4",
    messages=[{"role": "user", "content": "Hello!"}]
)
```

**curlå‘½ä»¤**:
```bash
curl -X POST http://127.0.0.1:8003/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-api-key" \
  -d '{
    "model": "gpt-4",
    "messages": [{"role": "user", "content": "Hello!"}]
  }'
```

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯

### âš¡ **é«˜æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯**
1. **Winloopäº‹ä»¶å¾ªç¯** - Windowsç¯å¢ƒæ€§èƒ½ä¼˜åŒ–
2. **Redisè¿æ¥æ± ** - é«˜å¹¶å‘è¿æ¥ç®¡ç†
3. **Luaè„šæœ¬ä¼˜åŒ–** - åŸå­æ“ä½œ + ç®—æ³•ä¼˜åŒ– 
4. **æƒé‡ç¼–ç Tokenè®°å½•** - O(1)å­˜å‚¨å¤æ‚åº¦
5. **è®¡æ•°å™¨ + å®šæœŸæ ¡å‡†** - å…¼é¡¾æ€§èƒ½ä¸ç²¾åº¦

### ğŸ§® **ç®—æ³•å¤æ‚åº¦**
- **æ—¶é—´å¤æ‚åº¦**: O(log N + R) 
- **ç©ºé—´å¤æ‚åº¦**: O(R)
- **ç½‘ç»œè°ƒç”¨**: O(1) æ¯æ¬¡è¯·æ±‚

### ğŸ“Š **Luaè„šæœ¬æ ¸å¿ƒç®—æ³•**
```lua
-- æ ¸å¿ƒä¼˜åŒ–ï¼šæƒé‡ç¼–ç  + è®¡æ•°å™¨æ··åˆç­–ç•¥
local function record_tokens_optimized(key, tokens, request_id)
    -- å•æ¬¡è°ƒç”¨è®°å½•æ‰€æœ‰tokens  
    local member = request_id .. ':' .. tokens
    redis.call('ZADD', key, current_time, member)
    
    -- è®¡æ•°å™¨å¿«é€Ÿæ›´æ–°
    redis.call('INCRBY', key .. ':counter', tokens)
end
```

## ğŸ§ª æµ‹è¯•ä½“ç³»

### ğŸš€ **æ€§èƒ½æµ‹è¯•**
- **é«˜è´Ÿè½½å‹åŠ›æµ‹è¯•** - éªŒè¯ç³»ç»Ÿæé™æ€§èƒ½
- **å¹¶å‘ç¨³å®šæ€§æµ‹è¯•** - éªŒè¯é«˜å¹¶å‘ä¸‹çš„ç¨³å®šæ€§  
- **çº¿æ€§æ‰©å±•æµ‹è¯•** - éªŒè¯åˆ†å¸ƒå¼æ‰©å±•èƒ½åŠ›

### âœ… **åŠŸèƒ½æµ‹è¯•**
- **é€Ÿç‡é™åˆ¶éªŒè¯** - ç¡®ä¿é™åˆ¶æ­£ç¡®ç”Ÿæ•ˆ
- **APIå…¼å®¹æ€§æµ‹è¯•** - éªŒè¯OpenAIå®¢æˆ·ç«¯å…¼å®¹
- **åˆ†å¸ƒå¼ä¸€è‡´æ€§** - éªŒè¯å¤šèŠ‚ç‚¹çŠ¶æ€åŒæ­¥

## ğŸ¯ åŸºå‡†å¯¹æ¯”

### ä¸ä¸šç•Œæ ‡å‡†å¯¹æ¯”

| æŒ‡æ ‡ | æœ¬ç³»ç»Ÿ | ä¸šç•Œæ ‡å‡† | è¯„ä»· |
|------|--------|----------|------|
| **å•èŠ‚ç‚¹QPS** | 738+ | 200-500 | **ä¼˜ç§€** â­â­â­â­â­ |
| **å¹³å‡å»¶è¿Ÿ** | 1.3ms | 5-10ms | **å“è¶Š** â­â­â­â­â­ |
| **P99å»¶è¿Ÿ** | 16.1ms | 50-100ms | **ä¼˜ç§€** â­â­â­â­â­ |
| **æˆåŠŸç‡** | 100% | 99.9% | **å®Œç¾** â­â­â­â­â­ |
| **æ°´å¹³æ‰©å±•** | 3.33å€ | 2-2.5å€ | **å“è¶Š** â­â­â­â­â­ |

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

### ğŸ“‹ **è´¡çŒ®æŒ‡å—**
1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. æ‰“å¼€ Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ LICENSE æ–‡ä»¶äº†è§£è¯¦æƒ…

## ğŸ† è‡´è°¢

- **Redis** - æä¾›é«˜æ€§èƒ½æ•°æ®å­˜å‚¨
- **FastAPI** - ç°ä»£åŒ–APIæ¡†æ¶  
- **Winloop** - Windowsç¯å¢ƒäº‹ä»¶å¾ªç¯ä¼˜åŒ–
- **OpenAI** - APIè§„èŒƒå‚è€ƒ

---

â­ **å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ªStarï¼** â­

ğŸ“§ **è”ç³»æ–¹å¼**: [cyh2022@mail.ustc.edu.cn]

ğŸ”— **é¡¹ç›®é“¾æ¥**: [https://github.com/eteledbat/api-rate-limiter]